<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlipMetrics - Analisi Investimenti Immobiliari</title>
    <!-- PWA Manifest and Icons -->
    <link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;FlipMetrics&quot;,&quot;short_name&quot;:&quot;FlipMetrics&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#007AFF&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;https://i.ibb.co/9g38Z4v/icon-192x192.png&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/png&quot;},{&quot;src&quot;:&quot;https://i.ibb.co/sK0Y1Vq/icon-512x512.png&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/png&quot;}]}">
    <link rel="apple-touch-icon" href="https://i.ibb.co/9g38Z4v/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FlipMetrics">
    
    <style>
        :root { --primary: #007AFF; --primary-light: #5AC8FA; --secondary: #5856D6; --tertiary: #34C759; --gray-dark: #48484A; --gray-medium: #8E8E93; --gray-light: #C7C7CC; --gray-ultralight: #F2F2F7; --background: #FFFFFF; --surface: #F5F5F7; --border: #D1D1D6; --text: #1C1C1E; --text-secondary: #86868B; --success: #34C759; --danger: #FF3B30; --warning: #FF9500; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif; background: var(--surface); color: var(--text); line-height: 1.47; }
        .container { max-width: 1200px; margin: 40px auto; background: var(--background); border-radius: 18px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.07); }
        .header { padding: 48px; text-align: center; border-bottom: 1px solid var(--border); }
        .header h1 { font-size: 48px; font-weight: 600; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;}
        .header .subtitle { font-size: 21px; color: var(--text-secondary); }
        .nav-tabs { display: flex; border-bottom: 1px solid var(--border); padding: 0 48px; }
        .nav-tab { padding: 16px 24px; background: transparent; border: none; font-size: 17px; color: var(--text-secondary); cursor: pointer; position: relative; border-bottom: 3px solid transparent; margin-bottom: -1px; }
        .nav-tab.active { font-weight: 500; }
        .nav-tab:nth-child(1).active { color: var(--primary); border-bottom-color: var(--primary); }
        .nav-tab:nth-child(2).active { color: var(--secondary); border-bottom-color: var(--secondary); }
        .nav-tab:nth-child(3).active { color: var(--tertiary); border-bottom-color: var(--tertiary); }
        .tab-content { display: none; padding: 48px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        .section { margin-bottom: 48px; }
        .section-title { font-size: 28px; font-weight: 500; margin-bottom: 24px; }
        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 15px; font-weight: 500; }
        .form-control { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 10px; font-size: 17px; }
        .input-with-suffix { position: relative; }
        .input-suffix { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .photo-upload { border: 2px dashed var(--border); border-radius: 12px; padding: 32px; text-align: center; cursor: pointer; background: var(--surface); }
        .photo-preview { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; }
        .photo-preview img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border); }
        .highlight-section { background: linear-gradient(135deg, #007AFF15 0%, #5856D615 100%); border-radius: 18px; padding: 32px; margin-bottom: 48px; }
        .highlight-input { font-size: 32px; font-weight: 500; padding: 16px; text-align: center; border: 2px solid var(--primary); }
        .cost-category { margin-bottom: 24px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .cost-header { padding: 16px 24px; background: var(--surface); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .category-name { font-size: 17px; font-weight: 500; }
        .category-total { font-size: 21px; font-weight: 600; color: var(--primary); }
        .cost-items { padding: 24px; background: var(--background); display: none; }
        .cost-items.active { display: block; }
        .cost-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--surface); }
        .cost-item:last-of-type { border-bottom: none; margin-bottom: 0; }
        .cost-item-name { flex-basis: 50%; }
        .cost-item-value { display: flex; align-items: center; gap: 8px; }
        .cost-item-value input { width: 140px; text-align: right; }
        .btn-add-wrapper { margin-top: 16px; }
        .btn-add { display: inline-block; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; }
        .btn-remove { background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; padding: 4px 12px; font-size: 14px; }
        .calculation-section { background: linear-gradient(135deg, var(--tertiary) 0%, var(--primary) 100%); border-radius: 18px; padding: 48px; color: white; }
        .calculation-row { display: flex; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.2); font-size: 19px; }
        .calculation-result { font-size: 48px; font-weight: 700; text-align: center; margin-top: 32px; padding: 32px; background: rgba(255,255,255,0.15); border-radius: 12px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-top: 32px; }
        .metric-card { background: var(--background); padding: 24px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .metric-label { font-size: 13px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px;}
        .metric-value { font-size: 32px; font-weight: 600; }
        .analysis-card { background: var(--background); border: 1px solid var(--border); border-radius: 12px; padding: 32px; margin-bottom: 24px; }
        .analysis-title { font-size: 24px; font-weight: 600; margin-bottom: 16px; }
        .city-selector { text-align: center; margin-bottom: 24px; }
        .city-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .city-card { background: var(--surface); padding: 24px; border-radius: 12px; text-align: center; transition: all 0.3s; }
        .city-card.selected { border: 2px solid var(--primary); background: white; transform: scale(1.05); }
        .city-roi { font-size: 28px; font-weight: 700; color: var(--primary); }
        .recommendation-box { color: white; padding: 24px; border-radius: 12px; margin-top: 24px; }
        .recommendation-box.success { background: var(--success); }
        .recommendation-box.warning { background: var(--danger); }
        .recommendation-box.neutral { background: var(--gray-medium); }
        .action-buttons { display: flex; justify-content: center; gap: 16px; padding: 48px; background: var(--surface); }
        .btn { padding: 12px 32px; border-radius: 980px; font-size: 17px; cursor: pointer; border: none; }
        .btn:disabled { background-color: var(--gray-light); cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: var(--background); }
        .btn-secondary { background: var(--background); color: var(--primary); border: 1px solid var(--primary); }
        .btn-success { background: var(--tertiary); color: white; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--background); margin: 10% auto; padding: 32px; width: 80%; max-width: 700px; border-radius: 18px; animation: fadeIn 0.3s; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
        .modal-title { font-size: 24px; }
        .close-btn { color: var(--gray-medium); font-size: 28px; cursor: pointer; }
        .project-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
        .project-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-radius: 12px; margin-bottom: 12px; background: var(--surface); }
        .project-info .project-name { font-size: 18px; font-weight: 500; }
        .project-info .project-date { font-size: 14px; color: var(--text-secondary); }
        .project-actions button { background: none; border: none; cursor: pointer; padding: 8px; }
        .project-actions .icon { width: 24px; height: 24px; }
        .status-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--gray-dark); color: white; text-align: center; padding: 8px; font-size: 14px; z-index: 1001; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 768px) { .grid-2, .metrics-grid, .city-grid { grid-template-columns: 1fr; } }
        @media print { /* Print styles here */ }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>FlipMetrics</h1>
            <p class="subtitle">Analisi Professionale per Investimenti Immobiliari</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab(event, 'info')">Informazioni</button>
            <button class="nav-tab" onclick="switchTab(event, 'params')">Parametri Finanziari</button>
            <button class="nav-tab" onclick="switchTab(event, 'results')">Analisi</button>
        </div>

        <!-- Tab: Informazioni -->
        <div id="info" class="tab-content active">
            <div class="section">
                <h3 class="section-title">Dettagli Immobile</h3>
                <div class="form-group"><label>Indirizzo Completo</label><input type="text" class="form-control" id="indirizzo"></div>
                <div class="grid-2">
                    <div class="form-group"><label>Piano</label><input type="text" class="form-control" id="piano"></div>
                    <div class="form-group"><label>Tipologia</label><select class="form-control" id="tipologia"><option>Appartamento</option><option>Villa</option><option>Attico</option><option>Loft</option></select></div>
                </div>
                <div class="grid-2">
                    <div class="form-group"><label>Metri Quadri</label><div class="input-with-suffix"><input type="number" class="form-control" id="metri" oninput="updateCalculations()"><span class="input-suffix">m²</span></div></div>
                    <div class="form-group"><label>Prezzo Venditore</label><div class="input-with-suffix"><input type="number" class="form-control" id="prezzoVenditore" oninput="updateCalculations()"><span class="input-suffix">€</span></div></div>
                </div>
                <div class="form-group"><label>Prezzo al Metro Quadro</label><div class="input-with-suffix"><input type="text" class="form-control" id="euroMetro" readonly style="background: var(--surface);"><span class="input-suffix">€/m²</span></div></div>
            </div>
            <div class="section">
                <h3 class="section-title">Contatti</h3>
                <div class="grid-2">
                    <div class="form-group"><label>Agenzia</label><input type="text" class="form-control" id="agenzia"></div>
                    <div class="form-group"><label>Agente</label><input type="text" class="form-control" id="agente"></div>
                </div>
                <div class="form-group"><label>Proprietario</label><input type="text" class="form-control" id="proprietario"></div>
                <div class="form-group"><label>Link Annuncio</label><input type="url" class="form-control" id="linkAnnuncio"></div>
            </div>
            <div class="section">
                <h3 class="section-title">Note</h3>
                <textarea class="form-control" id="note" rows="5"></textarea>
            </div>
            <div class="section">
                 <h3 class="section-title">Documentazione Fotografica</h3>
                <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                    <div>Clicca per caricare foto</div>
                </div>
                <input type="file" id="photoInput" multiple accept="image/*" style="display: none;" onchange="handlePhotos(event)">
                <div class="photo-preview" id="photoPreview"></div>
            </div>
        </div>

        <!-- Tab: Parametri Finanziari -->
        <div id="params" class="tab-content">
            <div class="highlight-section">
                <h3 class="section-title">Prezzo di Rivendita Stimato</h3>
                <div class="input-with-suffix"><input type="number" class="form-control highlight-input" id="prezzoRivendita" oninput="updateCalculations()"><span class="input-suffix">€</span></div>
            </div>
            
            <div id="cost-categories-container">
                <div class="cost-category">
                    <div class="cost-header" onclick="toggleCategory(event)">
                        <span class="category-name">Ristrutturazione</span>
                        <span class="category-total" id="totRistrutturazione">0 €</span>
                    </div>
                    <div class="cost-items" id="ristrutturazione-items">
                        <div class="cost-item"><span class="cost-item-name">Impresa Edile</span><div class="cost-item-value"><input type="number" class="form-control" oninput="updateCategoryTotal('Ristrutturazione')"><span>€</span></div></div>
                        <div class="cost-item"><span class="cost-item-name">Infissi</span><div class="cost-item-value"><input type="number" class="form-control" oninput="updateCategoryTotal('Ristrutturazione')"><span>€</span></div></div>
                        <div class="cost-item"><span class="cost-item-name">Impianto Elettrico</span><div class="cost-item-value"><input type="number" class="form-control" oninput="updateCategoryTotal('Ristrutturazione')"><span>€</span></div></div>
                        <div class="cost-item"><span class="cost-item-name">Impianto Idraulico</span><div class="cost-item-value"><input type="number" class="form-control" oninput="updateCategoryTotal('Ristrutturazione')"><span>€</span></div></div>
                        <div class="cost-item"><span class="cost-item-name">Pavimenti</span><div class="cost-item-value"><input type="number" class="form-control" oninput="updateCategoryTotal('Ristrutturazione')"><span>€</span></div></div>
                        <div class="cost-item"><span class="cost-item-name">Tinteggiatura</span><div class="cost-item-value"><input type="number" class="form-control" oninput="updateCategoryTotal('Ristrutturazione')"><span>€</span></div></div>
                        <div class="btn-add-wrapper"><button class="btn-add" onclick="addCustomItem(event, 'Ristrutturazione')">Aggiungi Voce</button></div>
                    </div>
                </div>
                 <div class="cost-category">
                    <div class="cost-header" onclick="toggleCategory(event)">
                        <span class="category-name">Professionisti</span>
                        <span class="category-total" id="totProfessionisti">0 €</span>
                    </div>
                    <div class="cost-items" id="professionisti-items">
                         <div class="cost-item"><span class="cost-item-name">Accatastamento</span><div class="cost-item-value"><input type="number" class="form-control" oninput="updateCategoryTotal('Professionisti')"><span>€</span></div></div>
                         <div class="cost-item"><span class="cost-item-name">Progetto Architettonico</span><div class="cost-item-value"><input type="number" class="form-control" oninput="updateCategoryTotal('Professionisti')"><span>€</span></div></div>
                         <div class="cost-item"><span class="cost-item-name">Pratiche Comunali</span><div class="cost-item-value"><input type="number" class="form-control" oninput="updateCategoryTotal('Professionisti')"><span>€</span></div></div>
                        <div class="btn-add-wrapper"><button class="btn-add" onclick="addCustomItem(event, 'Professionisti')">Aggiungi Voce</button></div>
                    </div>
                </div>
                 <div class="cost-category">
                    <div class="cost-header" onclick="toggleCategory(event)">
                        <span class="category-name">Agenzia</span>
                        <span class="category-total" id="totAgenzia">0 €</span>
                    </div>
                    <div class="cost-items" id="agenzia-items">
                         <div class="cost-item"><span class="cost-item-name">Provvigioni Acquisto</span><div class="cost-item-value"><input type="number" class="form-control" oninput="updateCategoryTotal('Agenzia')"><span>€</span></div></div>
                         <div class="cost-item"><span class="cost-item-name">Provvigioni Vendita</span><div class="cost-item-value"><input type="number" class="form-control" oninput="updateCategoryTotal('Agenzia')"><span>€</span></div></div>
                        <div class="btn-add-wrapper"><button class="btn-add" onclick="addCustomItem(event, 'Agenzia')">Aggiungi Voce</button></div>
                    </div>
                </div>
                 <div class="cost-category">
                    <div class="cost-header" onclick="toggleCategory(event)">
                        <span class="category-name">Utile Trading</span>
                        <span class="category-total" id="totUtile Trading">0 €</span>
                    </div>
                    <div class="cost-items" id="utiletrading-items">
                         <div class="cost-item"><span class="cost-item-name">Target Profitto</span><div class="cost-item-value"><input type="number" class="form-control" oninput="updateCategoryTotal('Utile Trading')"><span>€</span></div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Analisi -->
        <div id="results" class="tab-content">
            <div class="calculation-section">
                <h2 class="calculation-title">Proposta d'Acquisto</h2>
                <div class="calculation-row"><span>Prezzo Rivendita Stimato</span><span id="calcRivendita">0 €</span></div>
                <div class="calculation-row"><span>Totale Costi</span><span id="calcCosti">0 €</span></div>
                <div class="calculation-row"><span>Nostro Utile</span><span id="calcUtile">0 €</span></div>
                <div class="calculation-row"><span>Cifra da Offrire</span><span id="calcOfferta">0 €</span></div>
                <div class="calculation-result" id="finalResult">0 €</div>
            </div>
            <div class="metrics-grid">
                <div class="metric-card"><div class="metric-label">ROI</div><div class="metric-value" id="roiValue">0%</div></div>
                <div class="metric-card"><div class="metric-label">Margine</div><div class="metric-value" id="margineValue">0%</div></div>
                <div class="metric-card"><div class="metric-label">Differenza Venditore</div><div class="metric-value" id="diffVenditore">0 €</div></div>
            </div>
            <div class="analysis-card">
                <h3 class="analysis-title">Analisi ROI per Dimensione Città</h3>
                <div class="city-selector">
                    <label>Seleziona Dimensione Città:</label>
                    <select id="citySize" onchange="updateCityAnalysis()" class="form-control" style="width: auto; display: inline-block;"><option value="">-- Seleziona --</option><option value="grande">Città Grande</option><option value="media">Città Media</option><option value="piccola">Città Piccola</option></select>
                </div>
                <div class="city-grid">
                    <div class="city-card" id="cityGrande"><div class="city-type">Città Grandi</div><div class="city-roi">ROI: 18-22%</div></div>
                    <div class="city-card" id="cityMedia"><div class="city-type">Città Medie</div><div class="city-roi">ROI: 22-28%</div></div>
                    <div class="city-card" id="cityPiccola"><div class="city-type">Città Piccole</div><div class="city-roi">ROI: 25-35%</div></div>
                </div>
                <div id="recommendationBox" class="recommendation-box neutral"><p id="recommendationText">Seleziona la dimensione della città per ottenere una valutazione.</p></div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button id="saveBtn" class="btn btn-primary" onclick="saveProject()">Salva Progetto</button>
            <button id="manageBtn" class="btn btn-secondary" onclick="openProjectModal()">Gestisci Progetti</button>
            <button class="btn btn-success" onclick="printReport()">Stampa Report</button>
            <button class="btn btn-secondary" onclick="newProject()">Nuovo Progetto</button>
        </div>
    </div>

    <!-- Modal for Project Management -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">I Tuoi Progetti Salvati</h2><span class="close-btn" onclick="closeProjectModal()">&times;</span></div>
            <ul id="projectList" class="project-list"></ul>
        </div>
    </div>

    <!-- Status Bar -->
    <div id="statusBar" class="status-bar" style="display: none;"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, query, where, getDocs, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAqSe9ayymGSdVdLm4Dpl3-tLEkettrIkA",
            authDomain: "flipmetrics-database.firebaseapp.com",
            projectId: "flipmetrics-database",
            storageBucket: "flipmetrics-database.appspot.com",
            messagingSenderId: "718086843012",
            appId: "1:718086843012:web:7e28dff7dcfb12bbb670d1"
        };

        // --- App State ---
        let app, auth, db, storage;
        let isAuthReady = false;
        let userId = null;
        let uploadedPhotos = []; 
        
        // --- Initialization ---
        window.onload = () => {
            document.getElementById('saveBtn').disabled = true;
            document.getElementById('manageBtn').disabled = true;
            initializeFirebase();
            updateCalculations();
        };

        function initializeFirebase() {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("...") || firebaseConfig.storageBucket.includes("firebasestorage")) {
                 if (firebaseConfig.storageBucket.includes("firebasestorage")) {
                    console.warn("Firebase config storageBucket might be incorrect. It should not contain 'firebasestorage'. Using a corrected version.");
                    firebaseConfig.storageBucket = firebaseConfig.projectId + ".appspot.com";
                } else {
                    updateStatus("ERRORE: Inserisci la tua configurazione Firebase nel codice HTML.", false, 0);
                    return;
                }
            }
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
                updateStatus("Autenticazione in corso...");
                onAuthStateChanged(auth, user => {
                    if (user) {
                        isAuthReady = true;
                        userId = user.uid;
                        updateStatus("Autenticato. Pronto.", true);
                        document.getElementById('saveBtn').disabled = false;
                        document.getElementById('manageBtn').disabled = false;
                    } else {
                        signInAnonymously(auth).catch(error => updateStatus("Errore di autenticazione.", false, 10000));
                    }
                });
            } catch (error) {
                updateStatus("Errore: controlla la configurazione di Firebase.", false);
            }
        }
        
        function updateStatus(message, success = null, duration = 3000) {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = message;
            statusBar.style.display = 'block';
            statusBar.style.backgroundColor = success === true ? 'var(--success)' : success === false ? 'var(--danger)' : 'var(--gray-dark)';
            if (duration > 0) setTimeout(() => statusBar.style.display = 'none', duration);
        }

        // --- UI Functions ---
        function switchTab(event, tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function toggleCategory(event) {
            const items = event.currentTarget.nextElementSibling;
            items.classList.toggle('active');
        }
        
        function addCustomItem(event, categoryName) {
            const name = prompt("Nome della nuova voce:");
            if (!name) return;
            const container = event.currentTarget.parentElement.parentElement;
            const newItem = document.createElement('div');
            newItem.className = 'cost-item';
            newItem.innerHTML = `
                <span class="cost-item-name">${name}</span>
                <div class="cost-item-value">
                    <input type="number" class="form-control" oninput="updateCategoryTotal('${categoryName}')">
                    <span>€</span>
                    <button class="btn-remove" onclick="this.closest('.cost-item').remove(); updateCategoryTotal('${categoryName}')">Rimuovi</button>
                </div>`;
            container.insertBefore(newItem, event.currentTarget.parentElement);
        }

        function updateCategoryTotal(categoryName) {
            const header = Array.from(document.querySelectorAll('.category-name')).find(el => el.textContent === categoryName);
            if (!header) return;
            const container = header.closest('.cost-category').querySelector('.cost-items');
            const inputs = container.querySelectorAll('input[type="number"]');
            let total = 0;
            inputs.forEach(input => total += parseFloat(input.value) || 0);
            header.closest('.cost-category').querySelector('.category-total').textContent = `${total.toLocaleString('it-IT')} €`;
            updateCalculations();
        }

        function updateCalculations() {
            const metri = parseFloat(document.getElementById('metri').value) || 0;
            const prezzoVenditore = parseFloat(document.getElementById('prezzoVenditore').value) || 0;
            document.getElementById('euroMetro').value = metri > 0 ? (prezzoVenditore / metri).toFixed(2) : '0.00';

            const prezzoRivendita = parseFloat(document.getElementById('prezzoRivendita').value) || 0;
            let totaleCosti = 0;
            let utile = 0;

            document.querySelectorAll('.cost-category').forEach(categoryEl => {
                const categoryName = categoryEl.querySelector('.category-name').textContent;
                let categoryTotal = 0;
                categoryEl.querySelectorAll('.cost-item input[type="number"]').forEach(input => {
                    categoryTotal += parseFloat(input.value) || 0;
                });
                
                if (categoryName === 'Utile Trading') {
                    utile = categoryTotal;
                } else {
                    totaleCosti += categoryTotal;
                }
            });

            const offerta = prezzoRivendita - totaleCosti - utile;
            const roi = (utile > 0 && offerta > 0) ? (utile / offerta * 100) : 0;
            const margine = prezzoRivendita > 0 ? (utile / prezzoRivendita * 100) : 0;
            const diff = prezzoVenditore - offerta;

            document.getElementById('calcRivendita').textContent = `${prezzoRivendita.toLocaleString('it-IT')} €`;
            document.getElementById('calcCosti').textContent = `${totaleCosti.toLocaleString('it-IT')} €`;
            document.getElementById('calcUtile').textContent = `${utile.toLocaleString('it-IT')} €`;
            document.getElementById('calcOfferta').textContent = `${offerta.toLocaleString('it-IT')} €`;
            document.getElementById('finalResult').textContent = `${offerta.toLocaleString('it-IT')} €`;
            document.getElementById('roiValue').textContent = `${roi.toFixed(1)}%`;
            document.getElementById('margineValue').textContent = `${margine.toFixed(1)}%`;
            document.getElementById('diffVenditore').textContent = `${diff.toLocaleString('it-IT')} €`;

            updateCityAnalysis();
        }
        
        function updateCityAnalysis() {
            const selectedCity = document.getElementById('citySize').value;
            document.querySelectorAll('.city-card').forEach(c => c.classList.remove('selected'));
            const recommendationBox = document.getElementById('recommendationBox');
            const recommendationText = document.getElementById('recommendationText');
            
            if (!selectedCity) {
                recommendationBox.className = 'recommendation-box neutral';
                recommendationText.textContent = 'Seleziona la dimensione della città per ottenere una valutazione.';
                return;
            }

            document.getElementById(`city${selectedCity.charAt(0).toUpperCase() + selectedCity.slice(1)}`).classList.add('selected');
            
            const roi = parseFloat(document.getElementById('roiValue').textContent) || 0;
            const ranges = { grande: [18, 22], media: [22, 28], piccola: [25, 35] };
            const [min, max] = ranges[selectedCity];
            
            if (roi >= max) {
                recommendationBox.className = 'recommendation-box success';
                recommendationText.textContent = `ECCELLENTE: ROI del ${roi.toFixed(1)}% supera il massimo atteso (${max}%).`;
            } else if (roi >= min) {
                recommendationBox.className = 'recommendation-box success';
                recommendationText.textContent = `CONSIGLIATA: ROI del ${roi.toFixed(1)}% rientra nel range ottimale (${min}-${max}%).`;
            } else if (roi >= min - 3) {
                recommendationBox.className = 'recommendation-box neutral';
                recommendationText.textContent = `DA VALUTARE: ROI del ${roi.toFixed(1)}% è leggermente sotto il minimo (${min}%).`;
            } else {
                recommendationBox.className = 'recommendation-box warning';
                recommendationText.textContent = `NON CONSIGLIATA: ROI del ${roi.toFixed(1)}% è troppo basso per questo mercato.`;
            }
        }
        
        // --- Photo Management ---
        async function handlePhotos(event) {
            if (!isAuthReady) return updateStatus("Attendi l'autenticazione.", false);
            const files = event.target.files;
            updateStatus(`Caricamento di ${files.length} foto...`);
            for (let file of files) {
                const storageRef = ref(storage, `photos/${userId}/${Date.now()}_${file.name}`);
                try {
                    await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(storageRef);
                    uploadedPhotos.push(downloadURL);
                    renderPhotos();
                } catch (error) { 
                    console.error("Photo upload error:", error);
                    updateStatus("Errore caricamento foto. Controlla la configurazione di Storage.", false);
                }
            }
            updateStatus("Caricamento foto completato.", true);
        }

        function renderPhotos() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            uploadedPhotos.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                preview.appendChild(img);
            });
        }

        // --- Project Data Management (Cloud) ---
        function collectAllData() {
            const data = {};
            document.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.id) data[el.id] = el.value;
            });

            data.costItems = {};
             document.querySelectorAll('.cost-category').forEach(categoryEl => {
                const categoryName = categoryEl.querySelector('.category-name').textContent;
                data.costItems[categoryName] = [];
                categoryEl.querySelectorAll('.cost-item').forEach(itemEl => {
                    const name = itemEl.querySelector('.cost-item-name').textContent;
                    const value = itemEl.querySelector('input[type="number"]').value;
                    data.costItems[categoryName].push({ name, value });
                });
            });
            data.photos = uploadedPhotos;
            return data;
        }
        
        async function saveProject() {
            if (!isAuthReady) return;
            const projectName = prompt('Nome del progetto:');
            if (!projectName) return;
            
            updateStatus(`Salvataggio di "${projectName}"...`);
            try {
                await setDoc(doc(db, "projects", projectName), {
                    name: projectName,
                    savedAt: Timestamp.now(),
                    userId: userId,
                    data: collectAllData()
                });
                updateStatus(`Progetto "${projectName}" salvato!`, true);
            } catch (error) { updateStatus("Errore durante il salvataggio.", false); }
        }
        
        function restoreAllData(data) {
            newProject();
            
            for (const key in data) {
                const element = document.getElementById(key);
                if (element) element.value = data[key];
            }

            if (data.costItems) {
                for (const categoryName in data.costItems) {
                     const header = Array.from(document.querySelectorAll('.category-name')).find(el => el.textContent === categoryName);
                     if (!header) continue;
                     const container = header.closest('.cost-category').querySelector('.cost-items');
                     
                     container.querySelectorAll('.cost-item.dynamic').forEach(item => item.remove());

                     data.costItems[categoryName].forEach(itemData => {
                        let input = Array.from(container.querySelectorAll('.cost-item-name')).find(el => el.textContent === itemData.name)?.closest('.cost-item').querySelector('input');
                        
                        if (input) { 
                            input.value = itemData.value;
                        } else { 
                             const newItem = document.createElement('div');
                             newItem.className = 'cost-item dynamic';
                             newItem.innerHTML = `
                                <span class="cost-item-name">${itemData.name}</span>
                                <div class="cost-item-value">
                                    <input type="number" class="form-control" value="${itemData.value}" oninput="updateCategoryTotal('${categoryName}')">
                                    <span>€</span>
                                    <button class="btn-remove" onclick="this.closest('.cost-item').remove(); updateCategoryTotal('${categoryName}')">Rimuovi</button>
                                </div>`;
                             container.querySelector('.btn-add-wrapper').insertAdjacentElement('beforebegin', newItem);
                        }
                     });
                     updateCategoryTotal(categoryName);
                }
            }

            uploadedPhotos = data.photos || [];
            renderPhotos();
            updateCalculations();
        }
        
        async function loadProject(projectName) {
             try {
                const docSnap = await getDoc(doc(db, "projects", projectName));
                if (docSnap.exists()) {
                    restoreAllData(docSnap.data().data);
                    closeProjectModal();
                    updateStatus(`Progetto "${projectName}" caricato.`, true);
                }
            } catch (error) { updateStatus("Errore durante il caricamento.", false); }
        }

        async function deleteProject(projectName) {
            if (!confirm(`Sei sicuro di voler eliminare il progetto "${projectName}"?`)) return;
            updateStatus(`Eliminazione di "${projectName}"...`);
            try {
                const projectRef = doc(db, "projects", projectName);
                const docSnap = await getDoc(projectRef);
                if (docSnap.exists()) {
                    const photoURLs = docSnap.data().data.photos || [];
                    for (const url of photoURLs) {
                        await deleteObject(ref(storage, url)).catch(err => console.warn(err));
                    }
                }
                await deleteDoc(projectRef);
                updateStatus(`Progetto eliminato.`, true);
                openProjectModal();
            } catch (error) { updateStatus("Errore durante l'eliminazione.", false); }
        }

        async function openProjectModal() {
            if (!isAuthReady) return;
            const modal = document.getElementById('projectModal');
            const list = document.getElementById('projectList');
            list.innerHTML = '<li>Caricamento...</li>';
            modal.style.display = 'block';

            try {
                const q = query(collection(db, "projects"), where("userId", "==", userId), orderBy("savedAt", "desc"));
                const querySnapshot = await getDocs(q);
                list.innerHTML = '';
                if (querySnapshot.empty) {
                    list.innerHTML = '<li>Nessun progetto salvato.</li>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const project = doc.data();
                    const date = project.savedAt.toDate().toLocaleString('it-IT');
                    const li = document.createElement('li');
                    li.className = 'project-item';
                    li.innerHTML = `
                        <div class="project-info">
                            <span class="project-name">${project.name}</span>
                            <span class="project-date">Salvato il: ${date}</span>
                        </div>
                        <div class="project-actions">
                            <button onclick="window.loadProject('${project.name}')" title="Carica"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg></button>
                            <button onclick="window.deleteProject('${project.name}')" title="Elimina"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="#FF3B30" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                        </div>`;
                    list.appendChild(li);
                });
            } catch (error) {
                list.innerHTML = '<li>Errore nel caricare i progetti.</li>';
                 if (error.code === 'failed-precondition') {
                    updateStatus("Errore database: clicca il link nella console per creare l'indice Firestore.", false, 0);
                    console.error("Link per creare l'indice:", error.message.match(/https:\/\/.*/)[0]);
                }
            }
        }
        
        function closeProjectModal() {
            document.getElementById('projectModal').style.display = 'none';
        }
        
        function newProject() {
            document.querySelectorAll('input, textarea, select').forEach(el => el.value = '');
            uploadedPhotos = [];
            renderPhotos();
             document.querySelectorAll('.cost-item.dynamic').forEach(item => item.remove());
            updateCalculations();
        }

        function printReport() { window.print(); }

        // --- Expose functions to global window object ---
        Object.assign(window, {
            loadProject, deleteProject, openProjectModal, closeProjectModal, saveProject,
            handlePhotos, newProject, printReport, switchTab, toggleCategory, addCustomItem,
            updateCategoryTotal, updateCalculations, updateCityAnalysis
        });

    </script>
</body>
</html>

